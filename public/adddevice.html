<!DOCTYPE html>
<html>
<head>
	<title>Add Device</title>
	<meta charset="utf-8">
  <script src="/socket.io/socket.io.js"></script>
  <style type="text/css">
  body{width: 500px;}
  </style>
</head>
<body>
<input type="text" name="device-desp" placeholder="Device description">
<input type="text" name="room" placeholder="Room">
<button name="add-devide" onclick="addDevice()">Add Device</button>
<textarea name="textarea"></textarea>
<button name="send-test-room" onclick="sendTextToRoom()">Send To Room</button>
<button name="socket-status" onclick="socketStatus()">Socket Status</button>
<ul id="log-list"></ul>
<script>
var logList = document.getElementById('log-list');
var socket = io.connect('http://10.0.0.219:3334/', {
	'reconnection': true,
	'reconnectionDelay': 3000, 
	'reconnectionDelayMax': 2000,
	'timeout': 3000
});

socket.emit('leave-default-room', {});

if (window.localStorage.getItem('room')){
	var room = window.localStorage.getItem('room');
	var desp = window.localStorage.getItem('desp');
	socket.emit('joinmeto', {room: room, desp: desp});
	console.log(desp+room);
}

// if (window.localStorage.getItem('room')){
// 	/*var room = document.cookie.replace(/(?:(?:^|.*;\s*)room\s*\=\s*([^;]*).*$)|^.*$/, "$1");
// 	var desp = document.cookie.replace(/(?:(?:^|.*;\s*)desp\s*\=\s*([^;]*).*$)|^.*$/, "$1");*/
// 	var room = window.localStorage.getItem('room');
// 	var desp = window.localStorage.getItem('desp');
// 	socket.emit('joinmeto', {room: room, desp: desp});
// 	var li = document.createElement('li');
// 	var t = document.createTextNode('Te Has unido a este espacio');
// 	li.appendChild(t);
// 	logList.appendChild(li);
// }

function addDevice(){
	var desp = document.getElementsByName('device-desp')[0].value;
	var room = document.getElementsByName('room')[0].value;
	socket.emit('joinmeto', {room: room, desp: desp});
	// document.cookie = "room="+room;
	// document.cookie = "desp="+desp;
	window.localStorage.setItem('room', room);
	window.localStorage.setItem('desp', desp);
	console.log(window.localStorage.getItem('room'));
}	

function sendTextToRoom(){
	var text = document.getElementsByName('textarea')[0].value;
	var room = window.localStorage.getItem('room');
	socket.emit('to-room', {room: room, text: text});
}

function logToList (text){
	var li = document.createElement('li');
	var t = document.createTextNode(text);
	li.appendChild(t);
	logList.appendChild(li);
}

socket.on('connect', function (){
	logToList('Event: connect');
});
socket.on('connect_error', function (){
	logToList('Event: connect_error');
});
socket.on('connect_timeout', function (){
	logToList('Event: connect_timeout');
});
socket.on('reconnect', function (){
	logToList('Event: reconnect');
});
socket.on('reconnect_attempt', function (){
	logToList('Event: reconnect_attempt');
});
socket.on('reconnecting', function (){
	logToList('Event: reconnecting');
});
socket.on('reconnect_failed', function (){
	logToList('Event: reconnect_failed');
});
socket.on('disconnect', function (){
	logToList('Event: disconnect');
});

socket.on('message', function(data){
	document.getElementsByName('textarea')[0].value = data.msg;
});
socket.on('reconnect', function(){
	// var room = document.cookie.replace(/(?:(?:^|.*;\s*)room\s*\=\s*([^;]*).*$)|^.*$/, "$1");

	/*var room = document.cookie.replace(/(?:(?:^|.*;\s*)room\s*\=\s*([^;]*).*$)|^.*$/, "$1");
	var desp = document.cookie.replace(/(?:(?:^|.*;\s*)desp\s*\=\s*([^;]*).*$)|^.*$/, "$1");*/

	/*var desp = document.getElementsByName('device-desp')[0].value;
	var room = document.getElementsByName('room')[0].value;*/

	var room = window.localStorage.getItem('room');
	var desp = window.localStorage.getItem('desp');
	socket.emit('joinmeto', {room: room, desp: desp});
	socket.emit('leave-default-room', {});

	var li = document.createElement('li');
	var t = document.createTextNode('Reconnection');
	li.appendChild(t);
	logList.appendChild(li);
});  

socket.on('user-disconnected', function (data){
	console.log('Usuario desconectado: '+ data.id);
});

function getHiddenProp(){
	var prefixes = ['webkit', 'moz', 'ms', 'o'];
	if ('hidden' in document) return 'hidden';
	for (var i = 0; i < prefixes.length; i++){
		if ((prefixes[i] + 'Hidden') in document)
			return prefixes[i] + 'Hidden';
	}
	return null;
}

function isHidden(){
	var prop = getHiddenProp();
	if (!prop) return false;

	return document[prop];
}

var visProp = getHiddenProp();
if (visProp){
	var evtname = visProp.replace(/[H|h]idden/, '') + 'visibilitychange';
	document.addEventListener(evtname, visChange);
}

function visChange(){
	if (isHidden())
		console.log('Page Hidden');
	else{
		var checkStatus = socket.emit('check-status');
		checkStatus = checkStatus.connected;
		socket.disconnect();
		// var status = io.managers['http://10.0.0.219:3334'].connected[0].connected;
		var socket = io.connect('http://10.0.0.219:3334/', {
	'reconnection': true,
	'reconnectionDelay': 3000, 
	'reconnectionDelayMax': 2000,
	'timeout': 3000
});
		alert(checkStatus);
	}

}

function socketStatus(){
	var socket = io.connect('http://10.0.0.219:3334/', {
	'reconnection': true,
	'reconnectionDelay': 3000, 
	'reconnectionDelayMax': 2000,
	'timeout': 3000
});
	var checkStatus = socket.emit('check-status');
	checkStatus = checkStatus.connected;
	// var status = io.managers['http://10.0.0.219:3334'].connected[0].connected;
	if (checkStatus)
		alert('Socket connected')
	else
		alert('Socket disconnected');
}
</script>
</body>
</html>